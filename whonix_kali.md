# Анонимизация ОС

Во многих случаях, например, при анализе вредоносного программного обеспечения, необходимо изолировать всю операционную систему и анонимизировать её трафик таким образом, чтобы никакие действия в ней не привели к раскрытию нашего ip-адреса или утере важных данных. Мы предлагаем схему на основе связки Whonix, виртуальной машины, выступающей в качестве шлюза, перенаправляющего трафик в Tor, и любой другой виртуальной машиной.

# Подготовка к работе

Скачиваем Virtualbox, [Whonix Gateway](https://goo.gl/wq0IuZ), [Kali](https://goo.gl/sPcNTX). Проверяем ova-файл, устанавливаем и обновляем Whonix по инструкции на сайте. Для отключения графического интерфейса можно выделить виртуальной машине 120 Мб оперативной памяти. Проверяем файл с образом диска Kali, создаём под него новую виртуальную машину, в настройках сетевого адаптера VM выбираем внутреннюю сеть whonix. Включаем систему, настраиваем сеть вручную или с помощью Network Manager-а: `ip 10.152.152.11`, `шлюз 10.152.152.10`, `dns-сервер 10.152.152.10`.

Перед началом работы необходимо убедиться, что сеть работает нормально, а потом обновить ОС и установить все необходимые приложения, разумеется, не отключая Tor.

При этом ни в коем случае нельзя устанавливать Guest Additions, так как они синхронизируют время на реальной и виртуальной машине, расшаривают буфер обмена, могут получить доступ к микрофону и вообще содержат в себе довольно много потенциально опасной функциональности.

Для усложения отслеживания рекомендуем использовать Tor Browser с правами обычного пользователя, так как стандартный браузер Kali довольно редок и запускается от рута.

Устанавливаем sux, который позволит нам запускать графические приложения от имени другого пользователя

        wget http://ftp.us.debian.org/debian/pool/main/s/sux/sux_1.0.1-6_all.deb
        dpkg -i sux_1.0.1-6_all.deb

Скачиваем браузер со страницы https://www.torproject.org/download/download-easy.html.en
Проверяем целостность по [данной инструкции](https://www.torproject.org/docs/verifying-signatures.html.en).

Создаём пользователя torbrowser, логинимся в него через 'su'.
Распаковываем архив с правами этого пользователя

        tar xf tor-browser-linux64-4.5.3_en-US.tar.xz

По [этой инструкции](https://geektimes.ru/post/247784/) отключаем в нём Tor, так как весь трафик уже анонимизируется на виртуальной машине с Whonix, а Tor через Tor - это вредно и очень медленно.

Запускаем torbrowser:

        sux torbrowser tor-browser_en-US/Browser/start-tor-browser

Настройка ssh и sshfs для включенной машины проводится по этой [инструкции](https://www.whonix.org/wiki/Sshfs_into_Whonix-Workstation).

После этого необходимо создать снимок, из которого можно будет загружаться перед каждым сеансом работы, зная, что на компьютере не осталось никаких материалов от предыдущего. Для ещё более надежной защиты от фингерпринтинга можно каждый раз устанавливать и настраивать эти виртуальные машины заново.

# Во время работы

Перед запуском Whonix Gateway и Kali мы рекомендуем включить VPN и поставить на закачку несколько произвольных торрентов с большим количеством сидов, например, с популярными дистрибутивами Linux-a. Это очень сильно затруднит проведение атак, основанных на статистическом анализе трафика. Кроме того, чтобы избежать случайной утечки информации, желательно закрыть все посторонние программы. 
Затем, запускаем Whonix, дожидаемся конца первичной настройки, при необходимости восстанавливаем чистый снимок Kali и запускаем её. После окончания работы необходимо выключить сначала виртуальную машину с Kali, потом Whonix.

# Tips & Tricks

Чтобы сменить цепочку Tor-серверов и выходную ноду, необходимо запустить в консоли Whonix Gateway утилиту 'arm' и нажать клавишу "n".

Для безопасного обмена данными с выключенной виртуальной машиной можно монтировать её диски с помощью 'vdfuse'.

        sudo apt-get install vdfuse (для других дистрибутивов может быть иное)
        sudo vdfuse -t VMDK -f /path/Kali-Linux.vmdk /mnt/mountpoint1
        sudo mount /mnt/mountpoint1/Partition /mnt/mountpoint2

При подключении по ssh из реальной машины можно использовать `tmux` для одновременной работы с терминалом изнутри и снаружи VM. Для этого, необходимо запустить `tmux` в Kali, подключиться к ней по ssh и `tmux a`. 

Для приватной анонимной связи и передачи файлов рекомендуем torchat. Его стоит запускать в основной системе, чтобы предотвратить сценарий Tor-over-Tor, утечку и потерю данных. Для связи с группой лиц можно использовать свои irc или jabber серверы в качестве onion-ресурсов, рекомендуемый клиент - Pidgin, система криптографической защиты чатов - otr.

В случае, если необходимо анонимно работать с не TCP-шными протоколами, можно воспользоваться VPN (желательно, не требующей регистрации). Для этого обычно нужно скачать соответствующий конфигурационный файл, а затем использовать команду `sudo openvpn config.ovpn`.

# Меры предосторожности

Хотя данная схема и гарантирует защиту от утечки ip-адреса из виртуальной машины, для настоящей анонимности необходимо соблюдать следующие правила:

- нельзя подключаться к своим ресурсам
- нельзя заходить в аккаунты, которые использовались тобой без Tor-а
- нужно помнить, что все не шифрованные данные могут перехватываться exit nod-ой
- нельзя допускать прохождение трафика Tor-a через Tor, так ноды двух цепочек могут случайно совпасть, тем самым сокращая эффективную длину цепочки вплоть до 1 машины
- при передаче файлов нужно защищать их криптографическими и стеганографическими методами, используя утилиты 'gpg' и 'steghide', и анонимизировать их метаданные, например, с помощью 'mat' (Metadata Anonymisation Toolkit)
